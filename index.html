<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense Tracker</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="apple-touch-icon" href="favicon.png">
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <!-- Authentication Screen -->
    <div id="authContainer" class="auth-container">
        <div class="auth-box">
            <div class="auth-header">
                <img src="favicon.svg" alt="Logo" class="app-logo">
                <h1>Expense Tracker</h1>
            </div>
            <p class="auth-subtitle">Sign in to sync your expenses across devices</p>

            <div id="authError" class="auth-error hidden"></div>

            <form id="authForm">
                <div class="form-group">
                    <label for="authEmail">Email</label>
                    <input type="email" id="authEmail" placeholder="your@email.com" required>
                </div>
                <div class="form-group">
                    <label for="authPassword">Password</label>
                    <input type="password" id="authPassword" placeholder="Your password" minlength="6" required>
                </div>
                <div class="auth-buttons">
                    <button type="submit" class="btn" id="signInBtn">Sign In</button>
                    <button type="button" class="btn btn-secondary" id="signUpBtn">Create Account</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Main App (hidden until logged in) -->
    <div id="appContainer" class="hidden">
        <div class="container">
            <header>
                <div class="header-top">
                    <div class="header-brand">
                        <img src="favicon.svg" alt="Logo" class="app-logo-small">
                        <h1>Expense Tracker</h1>
                    </div>
                    <div class="user-info">
                        <span id="userEmail"></span>
                        <button id="openSettingsBtn" class="btn btn-small btn-text" title="Settings">&#9881; Settings</button>
                        <button id="signOutBtn" class="btn btn-small btn-secondary">Sign Out</button>
                    </div>
                </div>
                <div class="month-selector">
                    <button id="prevMonth" class="nav-btn">&larr;</button>
                    <div class="month-display">
                        <span id="currentMonth"></span>
                        <button id="monthPickerBtn" class="picker-btn" title="Jump to month">&#9662;</button>
                    </div>
                    <button id="nextMonth" class="nav-btn">&rarr;</button>
                </div>
                <!-- Month/Year Picker Dropdown -->
                <div id="monthPicker" class="month-picker hidden">
                    <div class="picker-header">
                        <button id="pickerPrevYear" class="picker-nav">&larr;</button>
                        <span id="pickerYear"></span>
                        <button id="pickerNextYear" class="picker-nav">&rarr;</button>
                    </div>
                    <div class="picker-months" id="pickerMonths"></div>
                    <div class="picker-footer">
                        <button id="goToToday" class="btn btn-small">Today</button>
                    </div>
                </div>
            </header>

            <!-- Month Progress Visualization -->
            <div id="monthProgressContainer" class="month-progress-container"></div>

            <nav>
                <button class="nav-tab active" data-section="expenses">Expenses</button>
                <button class="nav-tab" data-section="budgets">Budgets</button>
                <button class="nav-tab" data-section="reports">Reports</button>
                <button class="nav-tab" data-section="history">History</button>
                <button class="nav-tab" data-section="data">Import/Export</button>
            </nav>

            <!-- Loading indicator -->
            <div id="loadingIndicator" class="loading-indicator hidden">
                <div class="spinner"></div>
                <span>Syncing...</span>
            </div>

            <!-- Expenses Section -->
            <section id="expenses" class="section active">

                <!-- Quick Stats -->
                <div id="quickStats" class="quick-stats-grid"></div>

                <!-- Monthly Income -->
                <div class="income-section">
                    <h3>Monthly Income</h3>
                    <form id="incomeForm" class="income-form">
                        <div class="income-input-row">
                            <div class="form-group">
                                <label for="incomeMonth">Month</label>
                                <input type="month" id="incomeMonth" required>
                            </div>
                            <div class="form-group income-amount-group">
                                <label for="netIncome">Amount (kr)</label>
                                <input type="number" id="netIncome" step="0.01" min="0" placeholder="e.g. 25000" required>
                            </div>
                            <button type="submit" class="btn btn-income">Save</button>
                        </div>
                    </form>
                    <div id="currentIncomeDisplay" class="current-income-display"></div>
                </div>

                <!-- Add Savings (compact with type boxes) -->
                <div class="savings-section">
                    <h3>Add Savings</h3>
                    <form id="savingsForm" class="savings-form">
                        <div class="savings-types">
                            <label class="savings-type-btn">
                                <input type="radio" name="savingsType" value="Emergency Buffer" checked>
                                <span>Emergency Buffer</span>
                            </label>
                            <label class="savings-type-btn">
                                <input type="radio" name="savingsType" value="Stocks">
                                <span>Stocks</span>
                            </label>
                            <label class="savings-type-btn">
                                <input type="radio" name="savingsType" value="ETFs/Funds">
                                <span>ETFs/Funds</span>
                            </label>
                            <label class="savings-type-btn">
                                <input type="radio" name="savingsType" value="Pension">
                                <span>Pension</span>
                            </label>
                            <label class="savings-type-btn">
                                <input type="radio" name="savingsType" value="Travel Savings">
                                <span>Travel</span>
                            </label>
                            <label class="savings-type-btn">
                                <input type="radio" name="savingsType" value="Other Savings">
                                <span>Other</span>
                            </label>
                        </div>
                        <div class="savings-input-row">
                            <div class="form-group">
                                <label for="savingsMonth">Month</label>
                                <input type="month" id="savingsMonth" required>
                            </div>
                            <div class="form-group">
                                <label for="savingsAmount">Amount (kr)</label>
                                <input type="number" id="savingsAmount" step="0.01" min="0" placeholder="0.00" required>
                            </div>
                            <button type="submit" class="btn btn-savings">Add</button>
                        </div>
                    </form>
                </div>

                <!-- Add Expense -->
                <h2>Add Expense</h2>
                <form id="expenseForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="description">Description</label>
                            <input type="text" id="description" placeholder="What did you spend on?" required>
                        </div>
                        <div class="form-group">
                            <label for="amount">Amount (kr)</label>
                            <input type="number" id="amount" step="0.01" min="0" placeholder="0.00" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Category</label>
                            <div id="expenseCategoryPicker"></div>
                        </div>
                        <div class="form-group">
                            <label for="date">Date</label>
                            <input type="date" id="date" required>
                        </div>
                    </div>
                    <button type="submit" class="btn">Add Expense</button>
                </form>

                <div class="expense-list" id="expenseList"></div>
            </section>

            <!-- Budgets Section -->
            <section id="budgets" class="section">
                <h2>Set Monthly Budgets</h2>
                <p class="section-description">Set spending limits per category. Budgets apply to the parent category (all subcategories combined).</p>
                <form id="budgetForm">
                    <div class="form-group">
                        <label>Select Category</label>
                        <div id="budgetCategorySelector" class="budget-category-select"></div>
                        <input type="hidden" id="budgetCategory" required>
                    </div>
                    <div class="form-group">
                        <label for="budgetAmount">Monthly Limit (kr)</label>
                        <input type="number" id="budgetAmount" step="0.01" min="0" placeholder="0.00" required>
                    </div>
                    <button type="submit" class="btn">Set Budget</button>
                </form>

                <div class="budget-list" id="budgetList"></div>
            </section>

            <!-- Reports Section -->
            <section id="reports" class="section">
                <h2>Monthly Report</h2>

                <!-- Money Flow Summary -->
                <div id="moneyFlowSummary" class="money-flow-summary"></div>

                <!-- Summary Cards -->
                <div class="summary-cards" id="summaryCards"></div>

                <!-- Spending by Category -->
                <div class="chart-container">
                    <h3 class="chart-title">Spending by Category</h3>
                    <div class="bar-chart" id="categoryChart"></div>
                </div>

                <!-- Savings Breakdown -->
                <div id="savingsSection" class="report-section hidden">
                    <h3>Savings This Month</h3>
                    <div id="savingsBreakdown" class="savings-breakdown"></div>
                </div>
            </section>

            <!-- History Section -->
            <section id="history" class="section">
                <h2>Historical Overview</h2>
                <p class="section-description">View your spending trends across months and years.</p>

                <div class="history-controls">
                    <label for="historyYear">Year:</label>
                    <select id="historyYear"></select>
                </div>

                <div class="history-grid" id="historyGrid"></div>

                <div class="chart-container">
                    <h3 class="chart-title">Monthly Spending Trend</h3>
                    <div class="trend-chart" id="trendChart"></div>
                </div>
            </section>

            <!-- Data Section -->
            <section id="data" class="section">
                <h2>Import / Export Data</h2>

                <!-- Sync Status -->
                <div class="data-card success-card">
                    <h3>Cloud Sync Active</h3>
                    <p>Your data is automatically synced across all your devices. Any changes you make will appear on your other devices within seconds.</p>
                </div>

                <!-- Bank Statement Import (CSV) -->
                <div class="data-card">
                    <h3>Import Bank Statement (CSV)</h3>
                    <p>Upload your bank statement to automatically import transactions. Supports most CSV formats.</p>
                    <div class="upload-area" id="csvDropZone">
                        <div class="upload-icon">&#128196;</div>
                        <p>Drag & drop your CSV file here, or click to browse</p>
                        <input type="file" id="csvFileInput" accept=".csv" hidden>
                    </div>
                    <div id="csvPreview" class="csv-preview hidden">
                        <h4>Preview Transactions</h4>
                        <div class="csv-mapping">
                            <div class="form-group">
                                <label for="csvDateCol">Date Column</label>
                                <select id="csvDateCol"></select>
                            </div>
                            <div class="form-group">
                                <label for="csvDescCol">Description Column</label>
                                <select id="csvDescCol"></select>
                            </div>
                            <div class="form-group">
                                <label for="csvAmountCol">Amount Column</label>
                                <select id="csvAmountCol"></select>
                            </div>
                        </div>
                        <div id="csvTransactions" class="csv-transactions"></div>
                        <div class="csv-actions">
                            <button id="importCsvBtn" class="btn btn-success">Import Selected</button>
                            <button id="cancelCsvBtn" class="btn btn-danger">Cancel</button>
                        </div>
                    </div>
                </div>

                <!-- Bank Statement Import (PDF) -->
                <div class="data-card">
                    <h3>Import Bank Statement (PDF)</h3>
                    <p>Upload a PDF bank statement. The app will try to extract transactions automatically.</p>
                    <div class="upload-area" id="pdfDropZone">
                        <div class="upload-icon">&#128462;</div>
                        <p>Drag & drop your PDF file here, or click to browse</p>
                        <input type="file" id="pdfFileInput" accept=".pdf" hidden>
                    </div>
                    <div id="pdfPreview" class="csv-preview hidden">
                        <h4>Preview Extracted Transactions</h4>
                        <p class="preview-note">Review and adjust categories before importing:</p>
                        <div id="pdfTransactions" class="csv-transactions"></div>
                        <div class="csv-actions">
                            <button id="importPdfBtn" class="btn btn-success">Import Selected</button>
                            <button id="cancelPdfBtn" class="btn btn-danger">Cancel</button>
                        </div>
                    </div>
                </div>

                <!-- JSON Export/Import -->
                <div class="data-card">
                    <h3>Backup & Restore</h3>
                    <p>Export all your data as a JSON file for backup, or import a previous backup.</p>
                    <div class="data-actions">
                        <button id="exportBtn" class="btn btn-success">Export Data</button>
                        <div class="file-input-wrapper">
                            <button class="btn">Import Backup</button>
                            <input type="file" id="jsonFileInput" accept=".json">
                        </div>
                    </div>
                </div>

                <!-- Danger Zone -->
                <div class="data-card danger">
                    <h3>Danger Zone</h3>
                    <p>Permanently delete all expense data. This cannot be undone.</p>
                    <button id="clearDataBtn" class="btn btn-danger">Clear All Data</button>
                </div>
            </section>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>App Settings</h2>
                <button class="close-modal" onclick="closeSettingsModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="settingsForm" onsubmit="event.preventDefault(); saveSettings();">
                    <div class="form-group">
                        <label for="settingPayday">Payday (Day of month)</label>
                        <select id="settingPayday" class="form-select">
                            <!-- Options 1-28, plus Last day logic maybe? For now 1-31 -->
                            <option value="1">1st</option>
                            <option value="2">2nd</option>
                            <option value="3">3rd</option>
                            <option value="4">4th</option>
                            <option value="5">5th</option>
                            <option value="6">6th</option>
                            <option value="7">7th</option>
                            <option value="8">8th</option>
                            <option value="9">9th</option>
                            <option value="10">10th</option>
                            <option value="11">11th</option>
                            <option value="12">12th</option>
                            <option value="13">13th</option>
                            <option value="14">14th</option>
                            <option value="15">15th</option>
                            <option value="16">16th</option>
                            <option value="17">17th</option>
                            <option value="18">18th</option>
                            <option value="19">19th</option>
                            <option value="20">20th</option>
                            <option value="21">21st</option>
                            <option value="22">22nd</option>
                            <option value="23">23rd</option>
                            <option value="24">24th</option>
                            <option value="25" selected>25th</option>
                            <option value="26">26th</option>
                            <option value="27">27th</option>
                            <option value="28">28th</option>
                            <option value="29">29th</option>
                            <option value="30">30th</option>
                            <option value="31">31st</option>
                        </select>
                        <p class="help-text">Your financial month starts on this day.</p>
                    </div>

                    <div class="form-group">
                        <label for="settingBalance">Current Account Balance</label>
                        <input type="number" id="settingBalance" step="0.01" placeholder="0.00">
                        <p class="help-text">Used to calculate "Available" budget.</p>
                    </div>

                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeSettingsModal()">Cancel</button>
                        <button type="submit" id="saveSettingsBtn" class="btn btn-primary">Save Settings</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="supabase.js"></script>
    <script src="categories.js"></script>
    <script src="settings.js"></script>
    <script src="app.js"></script>
    <script src="csv-import.js"></script>
    <script src="pdf-import.js"></script>
</body>
</html>
